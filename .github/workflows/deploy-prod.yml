name: Deploy to Production

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      confirm_production_deployment:
        description: 'Type "deploy-to-production" to confirm'
        required: true
        default: ''

jobs:
  validate-deployment:
    runs-on: ubuntu-latest
    steps:
      - name: Validate manual deployment confirmation
        if: github.event_name == 'workflow_dispatch'
        run: |
          if [ "${{ github.event.inputs.confirm_production_deployment }}" != "deploy-to-production" ]; then
            echo "❌ Production deployment not confirmed"
            exit 1
          fi
          echo "✅ Production deployment confirmed"

  deploy-prod:
    runs-on: ubuntu-latest
    needs: validate-deployment
    if: always() && (needs.validate-deployment.result == 'success' || github.event_name == 'release')
    environment: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install Databricks CLI
        run: |
          pip install databricks-cli
      
      - name: Validate Bundle
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
        run: |
          databricks bundle validate -t prod
      
      - name: Deploy Bundle to Production
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
        run: |
          databricks bundle deploy -t prod
      
      - name: Create Deployment Tag
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          TAG_NAME="prod-deployment-$TIMESTAMP"
          
          git tag -a $TAG_NAME -m "Production deployment at $TIMESTAMP"
          git push origin $TAG_NAME
      
      - name: Notify Success
        if: success()
        run: |
          echo "✅ Production deployment successful!"
          echo "Pipeline deployed to production environment"

